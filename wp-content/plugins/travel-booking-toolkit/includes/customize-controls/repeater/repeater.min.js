var travelbookingtoolkitRepeaterRow=function(e,t,i){"use strict";var a=this;this.rowIndex=e,this.container=t,this.label=i,this.header=this.container.find(".repeater-row-header"),this.header.on("click",function(){a.toggleMinimize()}),this.container.on("click",".repeater-row-remove",function(){a.remove()}),this.header.on("mousedown",function(){a.container.trigger("row:start-dragging")}),this.container.on("keyup change","input, select, textarea",function(e){a.container.trigger("row:update",[a.rowIndex,jQuery(e.target).data("field"),e.target])}),this.setRowIndex=function(e){this.rowIndex=e,this.container.attr("data-row",e),this.container.data("row",e),this.updateLabel()},this.toggleMinimize=function(){this.container.toggleClass("minimized"),this.header.find(".dashicons").toggleClass("dashicons-arrow-up").toggleClass("dashicons-arrow-down")},this.remove=function(){this.container.slideUp(300,function(){jQuery(this).detach()}),this.container.trigger("row:remove",[this.rowIndex])},this.updateLabel=function(){var e,t;"field"!==this.label.type||"function"!=typeof(e=this.container.find('.repeater-field [data-field="'+this.label.field+'"]')).val||""===(t=e.val())?this.header.find(".repeater-row-label").text(this.label.value+" "+(this.rowIndex+1)):this.header.find(".repeater-row-label").text(t)},this.updateLabel()};wp.customize.controlConstructor["travel-booking-toolkit-repeater"]=wp.customize.Control.extend({ready:function(){"use strict";var e,t=this,i=this.params.value;this.settingField=this.container.find("[data-customize-setting-link]").first(),this.setValue([],!1),this.repeaterFieldsContainer=this.container.find(".repeater-fields").first(),this.currentIndex=0,this.rows=[],e=!1,void 0!==this.params.choices.limit&&(e=!(0>=this.params.choices.limit)&&parseInt(this.params.choices.limit)),this.container.on("click","button.repeater-add",function(i){i.preventDefault(),!e||t.currentIndex<e?(t.addRow().toggleMinimize(),t.initColorPicker()):jQuery(t.selector+" .limit").addClass("highlight")}),this.container.on("click",".repeater-row-remove",function(i){t.currentIndex--,(!e||t.currentIndex<e)&&jQuery(t.selector+" .limit").removeClass("highlight")}),this.container.on("click keypress",".repeater-field-image .upload-button,.repeater-field-cropped_image .upload-button,.repeater-field-upload .upload-button",function(e){e.preventDefault(),t.$thisButton=jQuery(this),t.openFrame(e)}),this.container.on("click keypress",".repeater-field-image .remove-button,.repeater-field-cropped_image .remove-button",function(e){e.preventDefault(),t.$thisButton=jQuery(this),t.removeImage(e)}),this.container.on("click keypress",".repeater-field-upload .remove-button",function(e){e.preventDefault(),t.$thisButton=jQuery(this),t.removeFile(e)}),this.repeaterTemplate=_.memoize(function(){var e={evaluate:/<#([\s\S]+?)#>/g,interpolate:/\{\{\{([\s\S]+?)\}\}\}/g,escape:/\{\{([^\}]+?)\}\}(?!\})/g,variable:"data"};return function(i){return _.template(t.container.find(".customize-control-repeater-content").first().html(),null,e)(i)}}),i.length&&_.each(i,function(e){t.addRow(e),t.initColorPicker()}),this.setValue(i,!0,!0),this.repeaterFieldsContainer.sortable({handle:".repeater-row-header",update:function(e,i){t.sort()}})},openFrame:function(e){"use strict";wp.customize.utils.isKeydownButNotEnterEvent(e)||(this.$thisButton.closest(".repeater-field").hasClass("repeater-field-cropped_image")?this.initCropperFrame():this.initFrame(),this.frame.open())},initFrame:function(){"use strict";var e=this.getMimeType();this.frame=wp.media({states:[new wp.media.controller.Library({library:wp.media.query({type:e}),multiple:!1,date:!1})]}),this.frame.on("select",this.onSelect,this)},initCropperFrame:function(){"use strict";var e=this.$thisButton.siblings("input.hidden-field").attr("data-field"),t=this.getMimeType();"string"==typeof e&&""!==e&&"object"==typeof this.params.fields[e]&&"cropped_image"===this.params.fields[e].type&&["width","height","flex_width","flex_height"].forEach(function(t,i){void 0!==this.params.fields[e][t]&&(this.params[t]=this.params.fields[e][t])}.bind(this)),this.frame=wp.media({button:{text:"Select and Crop",close:!1},states:[new wp.media.controller.Library({library:wp.media.query({type:t}),multiple:!1,date:!1,suggestedWidth:this.params.width,suggestedHeight:this.params.height}),new wp.media.controller.CustomizeImageCropper({imgSelectOptions:this.calculateImageSelectOptions,control:this})]}),this.frame.on("select",this.onSelectForCrop,this),this.frame.on("cropped",this.onCropped,this),this.frame.on("skippedcrop",this.onSkippedCrop,this)},onSelect:function(){"use strict";var e=this.frame.state().get("selection").first().toJSON();this.$thisButton.closest(".repeater-field").hasClass("repeater-field-upload")?this.setFileInRepeaterField(e):this.setImageInRepeaterField(e)},onSelectForCrop:function(){"use strict";var e=this.frame.state().get("selection").first().toJSON();this.params.width!==e.width||this.params.height!==e.height||this.params.flex_width||this.params.flex_height?this.frame.setState("cropper"):this.setImageInRepeaterField(e)},onCropped:function(e){"use strict";this.setImageInRepeaterField(e)},calculateImageSelectOptions:function(e,t){"use strict";var i,a,r,s=t.get("control"),n=!!parseInt(s.params.flex_width,10),o=!!parseInt(s.params.flex_height,10),l=e.get("width"),d=e.get("height"),h=parseInt(s.params.width,10),c=parseInt(s.params.height,10),p=h/c,u=l,f=d;return t.set("canSkipCrop",!s.mustBeCropped(n,o,h,c,l,d)),u/f>p?h=(c=f)*p:c=(h=u)/p,r={handles:!0,keys:!0,instance:!0,persistent:!0,imageWidth:l,imageHeight:d,x1:i=(u-h)/2,y1:a=(f-c)/2,x2:h+i,y2:c+a},!1===o&&!1===n&&(r.aspectRatio=h+":"+c),!1===o&&(r.maxHeight=c),!1===n&&(r.maxWidth=h),r},mustBeCropped:function(e,t,i,a,r,s){"use strict";return(!0!==e||!0!==t)&&((!0!==e||a!==s)&&((!0!==t||i!==r)&&((i!==r||a!==s)&&!(r<=i))))},onSkippedCrop:function(){"use strict";var e=this.frame.state().get("selection").first().toJSON();this.setImageInRepeaterField(e)},setImageInRepeaterField:function(e){"use strict";var t=this.$thisButton.closest(".repeater-field-image,.repeater-field-cropped_image");t.find(".travel-booking-toolkit-image-attachment").html('<img src="'+e.url+'">').hide().slideDown("slow"),t.find(".hidden-field").val(e.id),this.$thisButton.text(this.$thisButton.data("alt-label")),t.find(".remove-button").show(),t.find("input, textarea, select").trigger("change"),this.frame.close()},setFileInRepeaterField:function(e){"use strict";var t=this.$thisButton.closest(".repeater-field-upload");t.find(".travel-booking-toolkit-file-attachment").html('<span class="file"><span class="dashicons dashicons-media-default"></span> '+e.filename+"</span>").hide().slideDown("slow"),t.find(".hidden-field").val(e.id),this.$thisButton.text(this.$thisButton.data("alt-label")),t.find(".upload-button").show(),t.find(".remove-button").show(),t.find("input, textarea, select").trigger("change"),this.frame.close()},getMimeType:function(){"use strict";var e=this.$thisButton.siblings("input.hidden-field").attr("data-field");return"string"==typeof e&&""!==e&&"object"==typeof this.params.fields[e]&&"upload"===this.params.fields[e].type&&void 0!==this.params.fields[e].mime_type?this.params.fields[e].mime_type:"image"},removeImage:function(e){"use strict";var t,i;wp.customize.utils.isKeydownButNotEnterEvent(e)||(i=(t=this.$thisButton.closest(".repeater-field-image,.repeater-field-cropped_image,.repeater-field-upload")).find(".upload-button"),t.find(".travel-booking-toolkit-image-attachment").slideUp("fast",function(){jQuery(this).show().html(jQuery(this).data("placeholder"))}),t.find(".hidden-field").val(""),i.text(i.data("label")),this.$thisButton.hide(),t.find("input, textarea, select").trigger("change"))},removeFile:function(e){"use strict";var t,i;wp.customize.utils.isKeydownButNotEnterEvent(e)||(i=(t=this.$thisButton.closest(".repeater-field-upload")).find(".upload-button"),t.find(".travel-booking-toolkit-file-attachment").slideUp("fast",function(){jQuery(this).show().html(jQuery(this).data("placeholder"))}),t.find(".hidden-field").val(""),i.text(i.data("label")),this.$thisButton.hide(),t.find("input, textarea, select").trigger("change"))},getValue:function(){"use strict";return JSON.parse(decodeURI(this.setting.get()))},setValue:function(e,t,i){"use strict";var a=e,r=[];i&&(jQuery.each(this.params.fields,function(e,t){"image"!==t.type&&"cropped_image"!==t.type&&"upload"!==t.type||r.push(e)}),jQuery.each(e,function(e,t){jQuery.each(r,function(i,r){void 0!==t[r]&&void 0!==t[r].id&&(a[e][r]=t[r].id)})})),this.setting.set(encodeURI(JSON.stringify(a))),t&&this.settingField.trigger("change")},addRow:function(e){"use strict";var t,i,a,r=this,s=r.repeaterTemplate(),n=this.getValue(),o={};if(s){if(t=jQuery.extend(!0,{},r.params.fields),e)for(a in e)e.hasOwnProperty(a)&&t.hasOwnProperty(a)&&(t[a].default=e[a]);for(a in t.index=this.currentIndex,s=s(t),(i=new travelbookingtoolkitRepeaterRow(r.currentIndex,jQuery(s).appendTo(r.repeaterFieldsContainer),r.params.row_label)).container.on("row:remove",function(e,t){r.deleteRow(t)}),i.container.on("row:update",function(e,t,a,s){r.updateField.call(r,e,t,a,s),i.updateLabel()}),this.rows[this.currentIndex]=i,t)t.hasOwnProperty(a)&&(o[a]=t[a].default);return n[this.currentIndex]=o,this.setValue(n,!0),this.currentIndex++,i}},sort:function(){"use strict";var e=this,t=this.repeaterFieldsContainer.find(".repeater-row"),i=[],a=e.getValue(),r=[],s=[];t.each(function(e,t){i.push(jQuery(t).data("row"))}),jQuery.each(i,function(t,i){r[t]=e.rows[i],r[t].setRowIndex(t),s[t]=a[i]}),e.rows=r,e.setValue(s)},deleteRow:function(e){"use strict";var t,i=this.getValue();for(t in i[e]&&this.rows[e]&&(delete i[e],delete this.rows[e],this.setValue(i,!0)),1,this.rows)this.rows.hasOwnProperty(t)&&this.rows[t]&&(this.rows[t].updateLabel(),0)},updateField:function(e,t,i,a){"use strict";var r,s,n;this.rows[t]&&this.params.fields[i]&&(r=this.params.fields[i].type,s=this.rows[t],n=this.getValue(),a=jQuery(a),void 0!==n[s.rowIndex][i]&&(n[s.rowIndex][i]="checkbox"===r?a.is(":checked"):a.val(),this.setValue(n,!0)))},initColorPicker:function(){"use strict";var e=this,t=e.container.find(".color-picker-hex"),i={},a=t.data("field");void 0!==a&&void 0!==e.params.fields[a]&&void 0!==e.params.fields[a].palettes&&"object"==typeof e.params.fields[a].palettes&&(i.palettes=e.params.fields[a].palettes),i.change=function(t,i){var a=jQuery(t.target),r=a.closest(".repeater-row").data("row"),s=e.getValue();s[r][a.data("field")]=i.color.toString(),e.setValue(s,!0)},0!==t.length&&t.wpColorPicker(i)}}),jQuery(document).ready(function(e){"use strict";e(document).on("click",".repeater-add",function(){e(".repeater-field").find('input[type="font"]').attr("placeholder","search icons")}),e(document).on("click",'input[type="font"]',function(){var t=e(this);!t.hasClass("ajax-running")&&t.siblings(".font-awesome-list").length<1&&e.ajax({type:"POST",url:ajaxurl,data:{action:"travel_booking_toolkit_get_fontawesome_ajax",travel_booking_toolkit_customize_nonce:travel_booking_toolkit_customize.nonce},beforeSend:function(){t.addClass("ajax-running")},success:function(e){var i='<div class="font-awesome-list">'+e+"</div>";t.after(i),t.removeClass("ajax-running")}})}),e(document).on("click",".font-group li",function(t){var i=e(this).data("font");e(this).parent().parent().siblings('input[type="font"]').val(i),e(this).parent().parent().siblings('input[type="font"]').trigger("change"),e(this).parent().parent().fadeOut("slow",function(){e(this).remove()}),t.preventDefault()}),e(document).on("keyup",'input[type="font"]',function(){var t=e(this).val(),i=new RegExp(t,"gi");e(this).next(".font-awesome-list").children(".font-group").children("li").show().not(function(){return i.test(e(this).find("svg").attr("class"))}).hide()})});