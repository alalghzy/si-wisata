"use strict";(self.webpackChunkwp_travel_engine=self.webpackChunkwp_travel_engine||[]).push([[5266],{5266:function(e,t,a){a.r(t);const i=lodash,{api:r,util:o,priceFormat:s,dateFormat:n}=window.wteL10n;t.default=class{constructor(e){var t,a=this;this.bookingform=e,this.summaryTemplate=wp.template("wte-booking-summary"),this.datetimeTemplate=wp.template("wte-booking-datetime"),this.state={selectedPackage:null,selectedDate:n(null),selectedTime:n(null),packageCategories:{},travelerRecord:{},availablePackages:[],availableTimes:[],extraServices:{},loading:!0,defaultDateFormat:"YYYY-MM-DD",cart:{},formatPrice:function(e){var t;const{currency:a,baseCurrency:i,currencySymbol:r,format:{number:o,price:s}}=wteL10n;let n={[i]:1};if("undefined"!=typeof wteCc&&null!==(t=wteCc)&&void 0!==t&&t.code)for(let e in wteCc.code)n={...n,[wteCc.code[e]]:wteCc.rate[e]};return e*=+n[a],wteL10n.helpers.priceFormat(e,a,r,s,+o.decimal,o.decimalSeparator,o.thousandSeparator)},groupPricings:{},cartTotal:{travelers:0}},this.extraServicesAPI=(t=this,()=>{let e=t._store,{trip:a}=e.getState();if(a.trip_extras.length<1)return;document.getElementById("wte-booking-extraservices-content").innerHTML=wp.template("wte-booking-extraservices")(),e.subscribe((()=>{let t=e.getState().services||{},a="";for(let i in t){let r=t[i],o=null==r?void 0:r.meta.wte_services.service_type;a+=wp.template(`wte-booking-es-${o}`)({service:r,extraServices:e.getState().extraServices})}document.getElementById("wte-booking-extraservices__services").innerHTML=a,document.getElementById("wte-booking-es-summary-content").innerHTML=wp.template("wte-booking-es-summary")(e.getState())})),e.dispatch(((t,i)=>{var r;fetch(`${wteL10n.wpapi.root}${wteL10n.wpapi.versionString}wte-services?include=${null===(r=a.trip_extras)||void 0===r?void 0:r.join(",")}`).then((t=>{t.json().then((t=>{t&&e.dispatch({type:"UPDATE_STORE",data:{services:lodash.keyBy(t,"id")}})}))}))}));const i=function(t){var a,i;let r=this,o=r.closest(".wte-booking-es-counter").dataset.info;o=o&&JSON.parse(o);let{serviceID:s,option:n}=o,l={[n]:1},c=0;if(r.classList.contains("wte-up"))c=1;else{if(!r.classList.contains("wte-down"))return;c=-1}let{extraServices:d,services:u,cartTotal:g,cart:p}=e.getState(),m=c>0?1:0;if(d[s]&&(m=c>0?d[s][n]?+d[s][n].count+1:1:d[s][n]?+d[s][n].count-1:0),m<0)return;let v=u[s]||{},f=null!==(a=null==v||null===(i=v.meta)||void 0===i?void 0:i.wte_services)&&void 0!==a?a:{},h=0,b="",k="unit";null!=f&&f.service_type&&("custom"===f.service_type?(b=f.options[n],h=+f.prices[n],k=f.service_unit):(b=v.title.rendered,h=+f.service_cost,k=f.service_unit)),l={...d[s],[n]:{count:m<0?0:m,unitPrice:h,label:b,per:k}};let w={...d,[s]:l},T=0,_=[];for(let e in w){let t=w[e];for(let e in t){let a=t[e];T+=+a.count*+a.unitPrice,+a.count>0&&(_=[..._,{extra_service:a.label,qty:a.count,price:+a.unitPrice}])}}p={...p,extraServices:_},e.dispatch({type:"UPDATE_STORE",data:{extraServices:w,cartTotal:{...g,services:T},cart:p}})};o.on("change",".wte-booking-es-select",(function(t){let a=this,i=a.dataset.info;i=i&&JSON.parse(i);let{extraServices:r,services:o}=e.getState(),{serviceID:s,option:n}=i,{options:l,service_unit:c,prices:d}=o[s].meta.wte_services,u={};u={...r,[s]:{[a.value]:{count:0,label:l[a.value],per:c,unitPrice:d[a.value]}}},e.dispatch({type:"UPDATE_STORE",data:{extraServices:u}})})),o.on("click",".wte-booking-es-counter .wte-up",i),o.on("click",".wte-booking-es-counter .wte-down",i)}),this._store=Redux.createStore((function(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:a.state,t=arguments.length>1?arguments[1]:void 0;switch(t.type){case"SET_TRIP":return{...e,trip:t.data};case"UPDATE_STORE":return{...e,...t.data};case"SET_DATE":return{...e,selectedDate:t.date};case"SET_TIME":return{...e,selectedTime:t.data};case"SET_PACKAGE":return{...e,selectedPackage:t.data};case"SET_TRAVELER_RECORD":return{...e,travelerRecord:t.data};default:return e}}),Redux.applyMiddleware((e=>t=>a=>"function"==typeof a?a(e.dispatch,e.getState):t(a)))),this.unsubscriber=this._store.subscribe((()=>{!this._store.getState().loading&&this._store.getState().trip&&(console.info("Initialize Booking Process",this._store.getState()),this.init())})),this._store.subscribe((()=>{this.updateSelectedTime(),this.updateSummary(),this.updatePackageTabContent()})),this._store.dispatch(((e,t)=>{var a;let i=r.get("trip",{id:wte.trip.id}),o=r.get("categories"),s=null!==(a=i.packages_ids)&&void 0!==a?a:[],n=[];try{if(!s)throw new Error(`No packages assigned to this trip - ${i.id}`);n=r.get("packages",{trip_id:wte.trip.id,per_page:100})}catch(e){console.warn("WTEBOOKING: "+e.message)}Promise.all([i,o,n]).then((t=>{const[a,i,r]=t;e({type:"UPDATE_STORE",data:{loading:!1,trip:a,tripPackagesIds:a.packages_ids||[],tripPackages:r,pricingCategories:i,primaryCategory:Object.values(i).find((e=>e["is-primary"]))}})}))})),this.priceFormat=function(e){return s(e)},this.cart={},this.currentTab=0,this.tabController={},this.timeformat="h:mm A",this.timeformatter=e=>(wteL10n.format.datetime.timezone,moment(e).format(this.timeformat)),this.addToCart=async e=>{var t,a;const{wpxhr:{root:i},tripID:r,_nonces:{addtocart:o}}=wteL10n;let{cart:s,selectedPackage:n,selectedDate:l,selectedTime:c,travelerRecord:d,cartTotal:u,packageCategories:g,groupPricings:p,trip:m}=this._store.getState();var v,f,h,b,k,w;if(""!=m.min_pax&&+m.min_pax>s.traveler)return alert(null===(v=wteL10n)||void 0===v||null===(f=v.l10n)||void 0===f||null===(h=f.invalidCartTraveler)||void 0===h?void 0:h.replace("%s",m.min_pax)),void e(!1);if(null===(t=s)||void 0===t||!t.traveler||s.traveler<1)return alert(null===(b=wteL10n)||void 0===b||null===(k=b.l10n)||void 0===k||null===(w=k.invalidCartTraveler)||void 0===w?void 0:w.replace("%s",1)),void e(!1);wteL10n.format.datetime.GMTOffset;let T=n,_=l.format("YYYY-MM-DD"),y=c.get()?c.format("YYYY-MM-DDTHH:mm"):"",P=d,C={};u=Object.values(u).reduce((function(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,t=arguments.length>1?arguments[1]:void 0;return+e+ +t}));for(let e in P){let t=P[e];if(t<1)continue;let a=g[e],i={pax:t,salePrice:null!=a&&a.salePrice?+a.salePrice:0,groupDiscountPrice:0,cost:+a.price};if(a.enabledSale&&(i.cost=a.salePrice),a.enabledGroupDiscount&&p&&p[e])for(let r of p[e]){if(r.to.length<1){i.cost=r.price.length>0?+r.price:+a.price;break}if(t>=+r.from&&t<=+r.to){i.cost=r.price.length>0?+r.price:+a.price;break}}i.categoryInfo=a,C={...C,[e]:i}}s={...s,nonce:o,tripID:r,packageID:T,tripDate:_,tripTime:y,travelers:P,cartTotal:u,pricingOptions:C,cversion:(null===(a=wteL10n)||void 0===a?void 0:a.cart_version)||"2.0"};const S=await fetch(`${i}?action=wte_add_trip_to_cart&cart_version=${s.cversion}&_nonce=${o}`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(s)}),D=await S.json();var x,E;D.success?window.location.href=null===(x=window)||void 0===x||null===(E=x.wp_travel_engine)||void 0===E?void 0:E.CheckoutURL:(D.data&&D.data[0]&&alert(D.data[0]),e(!1))}}init(){this.unsubscriber(),this.loadTemplates(),this.initTabController(),this.initCalendar(),this.eventListeners(),this.bookingProcessFlowControl()}initTabController(){var e=this;let t=this.bookingform.querySelectorAll(".wte-process-nav-item"),a=this.bookingform.querySelectorAll(".wte-process-tab-item");var i;this.tabController={tabCount:null==t?void 0:t.length,navigators:t,activeTab:"wte-booking-datetime",activeClass:"active",completedClass:"finish",nextBtn:"#wteProcessNext",prevBtn:"#wteProcessPrev",toggleNextBtn:function(){let t=!(arguments.length>0&&void 0!==arguments[0])||arguments[0];const a=document.querySelector(e.nextBtn);a&&(a.disabled=t)},finalAction:(i=this,function(){let e=document.querySelector(i.tabController.nextBtn);e&&(e.disabled=!0,e.classList.add("btn-loading")),i.addToCart((function(t){e.disabled=!!t,e.classList.toggle("btn-loading",!!t)}))}),validToNextProcess:(e=>function(){let t=e.tabController,a=document.querySelector(t.nextBtn);switch(t.activeTab){case"wte-booking-datetime":const{selectedDate:t,availableTimes:i,selectedTime:r}=e._store.getState();return t&&(null==t?void 0:t.get())&&(Object.keys(i).length<1||Object.keys(i).length&&(null==r?void 0:r.get()));case"wte-booking-packages":const{cart:o}=e._store.getState();return null!=o&&o.traveler&&o.traveler>0?(a.disabled=!1,!0):(a.disabled=!0,!1);default:return!0}})(this),switchBtnText:function(){let e=WTEBooking.tabController,t=document.querySelector(e.nextBtn);e.getActiveTabIndex()>=e.tabCount-1?t.textContent=t.dataset.labelCheckout||"Add to Cart":t.textContent=t.dataset.labelDefault||"Continue"},getActiveTabIndex:function(){let e=document.getElementById(this.activeTab);return Array.prototype.indexOf.call(a,e)},handleProcessBtnClick:function(e){let t=WTEBooking.tabController;if(this.matches(t.prevBtn))t.activeTab=a[t.getActiveTabIndex()-1].id;else if(this.matches(t.nextBtn)){let e=t.getActiveTabIndex()+1;if(e>=t.tabCount)t.finalAction();else{let i=a[e].id;t.validToNextProcess()&&(t.activeTab=i)}}t.switchBtnText(),t.getActiveTabIndex()>0?document.querySelector(t.prevBtn).style.removeProperty("display"):document.querySelector(t.prevBtn).style.display="none",t.showActiveTab()},init:function(){let e=this;e.showActiveTab();let t=+e.getActiveTabIndex();t<1&&(document.querySelector(e.prevBtn).style.display="none"),document.querySelector(".wte-process-nav-list").style.setProperty("--step-bar-width",(t+1)/3*100+"%"),o.on("click",e.nextBtn,e.handleProcessBtnClick),o.on("click",e.prevBtn,e.handleProcessBtnClick)},showActiveTab:function(){let e=this,t=+e.getActiveTabIndex();if(t<0)t=0;else if(t>=e.tabCount)t=e.tabCount-1;else{document.querySelector(".wte-process-nav-list").style.setProperty("--step-bar-width",(t+1)/3*100+"%");for(let i in Array.from(e.navigators)){let r=e.navigators[i];if(i<=t){if(i<t?r.classList.add(e.completedClass):r.classList.add(e.activeClass),i==t){for(let e in Array.from(a))a[e].style.removeProperty("display");document.querySelector("a"===r.tagName.toLowerCase()?r.hash:r.dataset.target).style.display="block"}}else r.classList.remove(e.activeClass,e.completedClass)}}}},this.tabController.init()}getJSONData(){return{trip:this.trip,tripPackages:this.tripPackages,availablePackages:this.availablePackages,selectedPackage:this.selectedPackage,packageCategories:this.getPackageCategories(this.selectedPackage),travelerRecord:this.travelerRecord,groupPricings:this.selectedPackage?this.tripPackages[this.selectedPackage]["group-pricing"]:{},formatPrice:this.formatPrice,selectedDate:this.selectedDate,cartTotal:this.calculateCartTotal(),selectedTime:this.selectedTime,availableTimes:this.availableTimes,extraServices:this.extraServices}}loadTemplates(){document.getElementById("wte-booking-datetime-content").innerHTML=this.datetimeTemplate(this._store.getState()),document.getElementById("wte-booking-packages-content").innerHTML=wp.template("wte-booking-packages")(this._store.getState()),document.getElementById("wte-booking-summary").innerHTML=wp.template("wte-booking-summary")(this._store.getState()),document.dispatchEvent(new Event("wteLoadBookingTemplates"))}calculateCartTotal(){let e=this.travelerRecord,t=0;for(let i in e){let r=e[i],o=this.getPackageCategories(this.selectedPackage)[i],s=o.enabledSale?+o.salePrice:+o.price,n=this.selectedPackage?this.tripPackages[this.selectedPackage]["group-pricing"]:{};if(Object.keys(n).length>0&&n[i]){var a=n[i];for(let e of a){if(e.to.length<1){s=e.price||s;break}if(+r>=+e.from&&+r<=+e.to){s=e.price;break}}}t+=s*+r}return t}eventListeners(){var e;o.on("click",".wte-package-select-btn",(e=this,function(t){let a=this.dataset.packageId,{tripPackages:i}=e._store.getState();const r=e.getDefaultCart(a);e._store.dispatch({type:"UPDATE_STORE",data:{selectedPackage:a,packageCategories:e.getPackageCategories(a),groupPricings:a?i[a]["group-pricing"]:{},...r}})}));const t=e=>function(t){var a;let i=this,r=0;if(i.classList.contains("wte-up"))r=1;else{if(!i.classList.contains("wte-down"))return;r=-1}let{travelerRecord:o,cart:s,cartTotal:n,packageCategories:l,tripPackages:c,selectedPackage:d,trip:u,selectedTime:g,selectedDate:p,parentDateConfig:m}=e._store.getState(),v={...s},f={...o},h=i.parentElement.dataset.info;h=h&&JSON.parse(h);const b=h.catID;if(f[b]<1&&r<0)return;let k=0;if(r>0?(k=f[b]?+f[b]+1:1,v.traveler=null!=v&&v.traveler?+v.traveler+1:1):(k=f[b]&&f[b]>=1?+f[b]-1:0,v.traveler=null!=v&&v.traveler?+v.traveler-1:0),k<0)return;let w=l[b].minPax;w&&k<w&&(v.traveler=v.traveler-r*(1-w),k=r<0?0:w);let T=l[b].maxPax;var _,y,P;if(T&&k>T&&(v.traveler=v.traveler-1,k=T),""!=u.max_pax&&+u.max_pax<v.traveler)return void alert(null===(_=wteL10n)||void 0===_||null===(y=_.l10n)||void 0===y||null===(P=y.availableSeatsExceed)||void 0===P?void 0:P.replace("%s",u.max_pax));let C=-1;if(g.get()){let e=g.format("YYYY-MM-DD-HH-mm-ss").split("-");e[1]=e[1]-1,C=.001*new Date(Date.UTC(...e)).getTime()}else if(null!=p&&p.get()){let e=p.format("YYYY-MM-DD").split("-");e[1]=e[1]-1,C=.001*new Date(Date.UTC(...e)).getTime()}if(m&&u["booked-seats"]&&u["booked-seats"][C]&&parseInt(null===(a=u["booked-seats"][C])||void 0===a?void 0:a.booked)){const e=m&&null!=m&&m._seats?parseInt(m._seats)-parseInt(u["booked-seats"][C].booked):-1;var S,D,x;if(""!==m._seats&&e>-1&&e<v.traveler)return void alert(null===(S=wteL10n)||void 0===S||null===(D=S.l10n)||void 0===D||null===(x=D.availableSeatsExceed)||void 0===x?void 0:x.replace("%s",e))}else if(m){var E,L,O;if(parseInt(m._seats)<+v.traveler)return void alert(null===(E=wteL10n)||void 0===E||null===(L=E.l10n)||void 0===L||null===(O=L.availableSeatsExceed)||void 0===O?void 0:O.replace("%s",m._seats))}f={...f,[b]:k};let I=0;for(let e in f){let t=f[e],a=l[e],i=a.enabledSale?+a.salePrice:+a.price,r=c[d]["group-pricing"]||{};if(a.enabledGroupDiscount&&Object.keys(r).length>0&&r[e]){var Y=r[e];for(let e of Y){if(e.to.length<1){i=e.price||i;break}if(+t>=+e.from&&+t<=+e.to){i=e.price;break}}}I+="per-group"===a.pricingType?t&&+i||0:i*+t}e._store.dispatch({type:"UPDATE_STORE",data:{travelerRecord:f,cart:v,cartTotal:{...n,travelers:I}}})};o.on("click",".wte-booking-pc-counter .wte-down",t(this)),o.on("click",".wte-booking-pc-counter .wte-up",t(this)),o.on("click",".wte-time-select-btn",(e=>function(t){var a;let i=this.dataset.time,r=this.dataset.packageId.split(","),{tripPackages:o}=e._store.getState();if(null!=e&&null!==(a=e.tabController)&&void 0!==a&&a.nextBtn){const t=document.querySelector(e.tabController.nextBtn);t&&(t.disabled=!1)}i&&e._store.dispatch({type:"UPDATE_STORE",data:{selectedTime:n(new Date(+i)),availablePackages:r.map((e=>o[e])),selectedPackage:r[0]}})})(this))}getPackageCategories(e){if(!e)return{};let{tripPackages:t}=this._store.getState();return t[e]["package-categories"]}clear(){this._store.dispatch({type:"UPDATE_STORE",data:{selectedDate:n(null),selectedTime:n(null),selectedPackage:null,defaultDateFormat:"YYYY-MM-DD",packageCategories:{},travelerRecord:{},cart:{}}})}updateSelectedTime(){document.getElementById("wte-booking-times-content").innerHTML=wp.template("wte-booking-times")(this._store.getState())}getDefaultCart(e){if(!e)return;let{tripPackages:t,trip:a}=this._store.getState();const i=this.getPackageCategories(e),r={};let o={traveler:0},s=0;const n=null==a?void 0:a.primary_category;if(!i[n])return{cart:o,cartTotal:{travelers:s},travelerRecord:r};let l=i[n],c=n,d=l.enabledSale?+l.salePrice:+l.price,u=parseInt(l.minPax);r[c]=u;let g=t[e]["group-pricing"]||{};if(l.enabledGroupDiscount&&Object.keys(g).length>0&&g[c]){var p=g[c];for(let e of p){if(e.to.length<1){d=e.price||d;break}if(u>=+e.from&&u<=+e.to){d=e.price;break}}}return o.traveler=parseInt(o.traveler)+u,s+="per-group"===l.pricingType?u&&+d||0:d*u,{cart:o,cartTotal:{travelers:s},travelerRecord:r}}bookingProcessFlowControl(e){const t=this;e||this.bookingform.classList.add("wte-bp-flow");const a=document.getElementById("wte-booking-datetime"),i={dateChange:function(){if(a&&t.bookingform.classList.contains("wte-bp-flow")){const e=a.offsetHeight;let t=a.children;if(t[0]){let i=t[0].offsetHeight,r=function(){a.scrollTop<i-e&&(a.scrollTop=i-e>a.scrollTop?a.scrollTop+10:a.scrollTop,setTimeout(r))};r()}}}};i[e]&&i[e]()}initCalendar(){let e=this.getPackagesDates();const t=Object.values(e._nodates);delete e._nodates;let{tripPackages:a,trip:i,cart:r}=this._store.getState();console.debug({_dates:e});let o=e._minDate;delete e._minDate;let s={minDate:o,inline:!0,onChange:(t,r)=>{var o,s;t[0].getTimezoneOffset(),t=new Date(t[0].getTime());let l=moment(t).format("YYYY-MM-DD");this.clear();let c=[];e[l]&&(c=Object.keys(e[l]).map((e=>a[e])));const d=Object.values(a).filter((e=>Object.values(e["package-dates"]).length<1));c=[...c,...d];let u=c.map((e=>e.id)),g=(null==i||null===(o=i.packages_ids)||void 0===o?void 0:o.find((e=>u.indexOf(e)>-1)))||c[0].id,p={};const m=this.getDefaultCart(g),v=e[l]&&e[l][g]||null;if(e[l])for(let[a,r]of Object.entries(e[l])){let e=r;if(!(e._times.length<1))for(let r in e._times){var f,h;let o=e._times[r],s=null==o||null===(f=o.from)||void 0===f?void 0:f.split(":"),n=new Date(t);n.setHours(s[0]),n.setMinutes(s[1]);let l=null==o||null===(h=o.to)||void 0===h?void 0:h.split(":"),c=new Date(t);c.setHours(l[0]),c.setMinutes(l[1]);let d="_"+moment(n).format("HH-mm")+"_"+moment(c).format("HH-mm");if(p[d]){p[d].packages=[...p[d].packages,a];continue}let u=!0;const g=i["booked-seats"],y=.001*n.getTime();if(g&&g[y]){var b,k,w,T,_;u=!(null===(b=g[y])||void 0===b||!b.booked)&&+(null===(k=g[y])||void 0===k?void 0:k.booked)>0;let e=null!=v&&v._seats&&null!==(w=g[y])&&void 0!==w&&w.booked?+v._seats-+g[y].booked:-1;u=!(null!=m&&null!==(T=m.cart)&&void 0!==T&&T.traveler)&&e>0&&e>(null==m||null===(_=m.cart)||void 0===_?void 0:_.traveler)}p[d]={from:n,to:c,packages:[a],formatter:this.timeformatter,isAvailable:u}}}const y=document.querySelector(null===(s=this.tabController)||void 0===s?void 0:s.nextBtn);t&&Object.values(p).length<=0?y&&(y.disabled=!1):y&&(y.disabled=!0),this._store.dispatch({type:"UPDATE_STORE",data:{...m,parentDateConfig:v,selectedDate:n(t),availablePackages:c,selectedPackage:g,availableTimes:p,packageCategories:this.getPackageCategories(g),groupPricings:g?a[g]["group-pricing"]:{}}}),this.bookingProcessFlowControl("dateChange")},disable:[e=>!1],onReady:function(){var e;const t=document.getElementById("open-booking-modal");if(t&&(t.disabled=!1),(null===(e=window.location.search)||void 0===e?void 0:e.split("&").indexOf("action=fsd_booking"))>-1){var a,i;let e=null===(a=window.location.search)||void 0===a?void 0:a.replace("?","").split("&").map((e=>e.split("="))).find((e=>"date"===e[0]));t.click(),null===(i=arguments.length<=2?void 0:arguments[2])||void 0===i||i.setDate(e,!0)}document.dispatchEvent(new Event("bookingCalendarReady"))}};s.disable=[(e=>{let a=o;return i=>!(!o||t.length>0&&moment(i).isSameOrAfter(a)||e[moment(i).format("YYYY-MM-DD")])})({...e})],flatpickr("#wte-booking-date-calendar",s)}formatPrice(e){var t;const{currency:a,baseCurrency:i,currencySymbol:r,format:{number:o,price:s}}=wteL10n;let n={[i]:1};if("undefined"!=typeof wteCc&&null!==(t=wteCc)&&void 0!==t&&t.code)for(let e in wteCc.code)n={...n,[wteCc.code[e]]:wteCc.rate[e]};return e*=+n[a],wteL10n.helpers.priceFormat(e,a,r,s,+o.decimal,o.decimalSeparator,o.thousandSeparator)}updateSummary(){document.getElementById("wte-booking-summary").innerHTML=wp.template("wte-booking-summary")(this._store.getState())}updatePackageTabContent(){document.getElementById("wte-booking-packages-content").innerHTML=wp.template("wte-booking-packages")(this._store.getState())}_dateToUTC(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;if("invalid date"!==(e=new Date(moment(e).tz("utc").toDate())).toString().toLowerCase()){let a=0,i=0;if(t){let e=t.split(":");a=+e[0],i=+e[1]}return new Date(Date.UTC(e.getUTCFullYear(),e.getMonth(),e.getDate(),a,i,0,0))}return e}_dateToTripTimeZone(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;if("invalid date"!==(e=new Date(e)).toString().toLowerCase()){if(e.setHours(0),e.setMinutes(0),e.setSeconds(0),t){let a=t.split(":");e.setHours(+a[0]),e.setMinutes(+a[1])}let a=`${moment(e).format("YYYY-MM-DDTHH:mm:ss")}${wteL10n.format.datetime.timezone}`;return new Date(a)}return e}getPackagesDates(){var e;const{tripPackages:t,trip:a}=this._store.getState();let r={_nodates:[]},o=new Date;o.setHours(0),o.setMinutes(0),o.setSeconds(0),o.setMilliseconds(0),null!==(e=a.cut_off_time)&&void 0!==e&&e.enabled&&(o=moment(o).add(a.cut_off_time.duration,a.cut_off_time.duration_unit).toDate());for(let e in t){let s=t[e]["package-dates"];if(s&&Object.values(s).length<1)r._nodates=[...r._nodates,e];else for(let t in s){let n=s[t],l=i.get(n,"dtstart",null);l=l.split("-");let c=new Date(Date.UTC(l[0],+l[1]-1,l[2],0,0,0,0)),d=c.getTime(),u=c;const g=i.get(n,"times",[]),p=i.get(n,"rrule",{}),m=!!i.get(n,"is_recurring",!1),v=i.get(n,"seats","");if(moment(u).isSameOrAfter(o)){let t=.001*d;if(""!==v&&a["booked-seats"]&&a["booked-seats"][+t]&&parseInt(a["booked-seats"][+t].booked)>=+v);else{let t=l.join("-");(!r._minDate||+r._minDate>moment(t).valueOf())&&(r._minDate=moment(t).valueOf()),r[t]={...r[t]?r[t]:{},[e]:{_times:g,_rrule:p,_isRecurring:m,_seats:v}}}}if(!m)continue;const{r_frequency:f,r_until:h,r_weekdays:b,r_months:k,r_count:w}=null!=p?p:{};let T={freq:f?rrule.RRule[f.toUpperCase()]:rrule.RRule.DAILY,dtstart:c};if(h){let e=this._dateToUTC(h);if(moment(o).isAfter(e))continue;T.until=e}switch(h||(T.count=w?+w:10),f){case"WEEKLY":T.byweekday=b&&Object.values(b).map((e=>rrule.RRule[e]))||[];break;case"MONTHLY":T.bymonth=k&&Object.keys(k).map((e=>+e))||[]}let _=new rrule.RRule(T).all(),y=0;for(let t in _){let i=_[t];if(moment(i.getTime()).isBefore(o))continue;0==t&&(y=T.dtstart.getTime()-i.getTime());let s=i.getTime()+y;if(""!==v&&a["booked-seats"]&&a["booked-seats"][s]&&parseInt(a["booked-seats"][s].booked)>=+v)continue;let n=moment.tz(moment(i).toISOString(),"UTC").format("YYYY-MM-DD"),l=moment(n).valueOf();(!r._minDate||+r._minDate>l)&&(r._minDate=l),r[n]={...r[n]?r[n]:{},[e]:{_times:g,_rrule:p,_isRecurring:m,_seats:v}}}}}return r._minDate||(r._minDate=o),r}async fetchData(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null;this.trip=await r.get("trip",{id:wte.trip.id}),this.tripPackagesIds=this.trip.packages_ids||[];try{if("object"!=typeof tripPackagesIds)throw`Trip Error: No Packages Assign to the trip - ${this.trip.id}.`;this.tripPackages=await r.get("packages",{include:this.tripPackagesIds.join(","),per_page:100})}catch(e){this.tripPackages=[],console.debug(`WTE Booking: ${e.message}`)}this.pricingCategories=await r.get("categories"),e&&e()}}}}]);